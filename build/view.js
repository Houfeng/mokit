/*csd*/define(function(require,exports,module){"use strict";var a=require("./jquery"),b=require("./class"),t=require("./tp"),u=require("./utils"),d=require("./ajax"),i=require("./json"),c=require("./model"),p=require("./store"),q=require("./task"),f=require("./console"),j=require("./language"),g=require("./event");var n=exports.rootContainer=a(document.body);t.extend(u);var s=exports.templateType={uri:"uri",element:"element",content:"content"};var r=p.dataCache;var k=function(y,x,w){if(!u.isFunction(w)){return;}if(u.isNull(x)){f.error("编译模板错误");}y=y||s.uri;if(y==s.element){w(a(x).html());}else{if(y==s.uri){d.get({url:x,callback:w,dataType:"text"});}else{w(x);}}};var e=function(z,y,x){if(!u.isFunction(x)){return;}if(u.isNull(y)){f.error("编译模板错误");}var w=y.split("?")[0].split("#")[0];if(r[w]){if(x){x(r[w]);}}else{k(z,y,function(A){r[w]=t.compile(A);if(x){x(r[w]);}});}};var h=function(y,x){if(!y||!x){return null;}var w=x.split(".");u.each(w,function(z,A){y=(A&&y[A])?y[A]:null;});return y;};var o=function(y,x,z){if(y===null||x===null||z===null){return;}var w=x.split(".");u.each(w,function(A,B){if(A<w.length-1){if(B&&!y[B]){y[B]=new c.Model();}y=y[B];}else{y[B]=z;}});};var m=function(x){var z={};var w=x.split(">");z.eventName=(w[0]||"");var y=(w[1]||"").split(":");z.methodName=(y[0]||"");z.methodArgs=(y[1]||"").split(",");if(u.contains(z.methodName,"!")){z.isViewMethod=true;z.methodName=z.methodName.toString().replace("!","");}return z;};var l=function(y){var z={};var x=y.split("<");z.filedName=(x[1]||"");var w=(x[0]||"").split(":");z.attrName=(w[0]||"");z.attrArg=(w[1]||"");return z;};var v=exports.View=b.create(function(){this.templateType="";this.template="";this.model=null;this.controller=null;this.ui=null;this.el=null;this.name="";this.container=null;this.initialize=function(w){var x=this;w=w||{};x.id=w.id||u.newGuid();x.model=w.model||x.model||{};x.controller=w.controller||x.controller||{};x.template=w.template||x.template||"";x.templateType=w.templateType||x.templateType||s.uri;x.options=w.options||x.options||{};x.elMap=x.el;if(x.model.registerView){x.model.registerView(x);}};this.setModel=function(w){var x=this;x.model=w;};this.handleEvent=function(){var x=this;var w=x.ui.find("[data-event]");if(x.ui.attr("data-event")){w.splice(0,0,x.ui[0]);}w.each(function(){var y=a(this);var z=y.attr("data-event");if(!z){return;}z=z.split(";");u.each(z,function(E,D){var C=m(D);var B=C.isViewMethod?x:x.controller;var A=B[C.methodName];if(A){y.on(C.eventName,function(F){var G=m(D);F.$element=y;F.element=y[0];F.view=x;F.routeData=x.controller.route.routeData;G.methodArgs.reverse();G.methodArgs.push(F);G.methodArgs.reverse();var H=A.apply(B,G.methodArgs);G=null;return H;});}else{f.error((C.isViewMethod?"method":"action")+' "'+C.methodName+'" not found');}C=null;});});};this.handleBind=function(){var x=this;var w=x.ui.find("[data-bind]");if(x.ui.attr("data-bind")){w.splice(0,0,x.ui[0]);}w.each(function(){var z=a(this);var y=z.attr("data-bind");if(!y){return;}y=y.split(";");u.each(y,function(C,A){A=l(A);if(z[A.attrName]){var B=h(x.model,A.filedName);if(A.attrName&&A.attrArg){z[A.attrName](A.attrArg,B);}else{z[A.attrName](B);}}});});};this.updateModel=function(){var x=this;if(!x||!x.ui){return;}var w=x.ui.find("[data-bind]");if(x.ui.attr("[data-bind]")){w.splice(0,0,x.ui[0]);}w.each(function(){var z=a(this);var y=z.attr("data-bind");if(!y){return;}y=y.split(";");u.each(y,function(B,A){A=l(A);if(z[A.attrName]){if(A.attrName&&A.attrArg){o(x.model,A.filedName,z[A.attrName](A.attrArg));}else{o(x.model,A.filedName,z[A.attrName]());}}});});return x.model;};this.handleChildView=function(){var z=this;z.children=z.children||{};var x=z.ui.find("[data-view]");var w={"view":z};if(x.length<1){if(z.onChildRender){z.onChildRender(w);}return;}var y=q.create();x.each(function(){var A=a(this);y.add(function(H){var G=A.attr("data-view");if(!G){return H();}var B=A.attr("id");if(u.isNull(B)){B=u.newGuid();A.attr("id",B);}var D=A.attr("data-model")||"";var C=h(z.model,D)||z.model;var F=A.attr("data-options")||"{}";var E=i.parse(F);if(z.children[B]){z.children[B].container=A;z.children[B].render(A,H);return;}G=module.resovleUri(G,z.templateType==s.uri?z.template:location.href);require(G,function(I){z[B]=z.children[B]=new I({id:B,model:C,controller:z.controller,options:E});z.children[B].parent=z;z.children[B].root=z.root||z;z.children[B].container=A;z.children[B].render(A,H);});});});y.end(function(){if(z.onChildRender){z.onChildRender(w);}});};this.setPageTitle=function(){var x=this;if(!x||!x.ui){return;}if(x.ui.attr("data-role")!="page"){return;}var w=x.ui.attr("data-title");if(w){document.title=w;}};this.mapElements=function(){var w=this;if(!w||!w.ui||!w.elMap){return;}w.el={};u.each(w.elMap,function(x){w.el[x]=w.ui.find(w.elMap[x]);});};this.render=function(x,w){var y=this;if(y.onPreInit){y.onPreInit({view:y});}e(y.templateType,y.template,function(B){var A=y.ui;y.ui=a(a.trim(B(y.model,{lang:j.current(),self:y,model:y.model,options:y.options})));if(!y.ui||y.ui.length<1){return f.error('"'+y.name+'" 发现异常');}y.root=y.root||y;var z={"view":y};y.mapElements(y);y.handleBind(y);y.handleEvent(y);y.handleChildView(y);y.setPageTitle(y);if(y.onInit){y.onInit(z);}if(A){A.remove();}y.container=x||y.container||n;y.container=u.isString(x)?a(y.container):y.container;if(!y.container){f.error("container error.");}if(y.container[0].tagName!=="LINK"){y.container.append(y.ui);}else{y.container.after(y.ui);}if(y.onRender){y.onRender(z);}if(w){w(y.ui);}});};this.remove=function(){var w=this;if(w.ui){w.ui.remove();}if(w.onRemove){w.onRemove({view:w});}if(w.model.removeView){w.model.removeView(w);}w.model=null;w.controller=null;w.ui=null;w.el=null;w.name=null;w.container=null;};this.hide=function(){var w=this;if(w.ui){w.ui.hide();}if(w.onHide){w.onHide({view:w});}};this.show=function(){var w=this;if(w.ui){w.ui.show();}if(w.onShow){w.onShow({view:w});}};});exports.create=function(w,x){if(!x){x=w;w=v;}return b.create(w,x);};});