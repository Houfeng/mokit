/*csd*/define(function(require,exports,module){"use strict";var a=require("./jquery"),b=require("./class"),y=require("./tp"),A=require("./utils"),d=require("./ajax"),l=require("./json"),c=require("./model"),u=require("./store"),v=require("./task"),f=require("./console"),m=require("./language"),g=require("./event");y.extend(A);var x=exports.templateType={uri:"uri",element:"element",content:"content"};var w=u.dataCache;var n=function(E,D,C){E=E||x.uri;if(!D||!C){return;}if(E==x.element){C(a(D).html());}else{if(E==x.uri){d.get({url:D,callback:C,dataType:"text"});}else{C(D);}}};var e=function(F,E,D){var C=E.split("?")[0].split("#")[0];if(w[C]){if(D){D(w[C]);}}else{n(F,E,function(G){w[C]=y.compile(G);if(D){D(w[C]);}});}};var h=function(E,D){if(!E||!D){return null;}var C=D.split(".");A.each(C,function(F,G){E=(G&&E[G])?E[G]:null;});return E;};var s=function(E,D,F){if(E===null||D===null||F===null){return;}var C=D.split(".");A.each(C,function(G,H){if(G<C.length-1){if(H&&!E[H]){E[H]=new c.Model();}E=E[H];}else{E[H]=F;}});};var q=function(D){var F={};var C=D.split(">");F.eventName=(C[0]||"");var E=(C[1]||"").split(":");F.methodName=(E[0]||"");F.methodArgs=(E[1]||"").split(",");if(A.contains(F.methodName,"!")){F.isViewMethod=true;F.methodName=F.methodName.toString().replace("!","");}return F;};var k=function(D){var C=D.ui.find("[data-event]");if(D.ui.attr("[data-event]")){C.splice(0,0,D.ui[0]);}C.each(function(){var E=a(this);var F=E.attr("data-event");if(!F){return;}F=F.split(";");A.each(F,function(K,J){var I=q(J);var H=I.isViewMethod?D:D.controller;var G=H[I.methodName];if(G){E.on(I.eventName,function(L){var M=q(J);L.$element=E;L.element=E[0];L.view=D;L.routeData=D.controller.route.routeData;M.methodArgs.reverse();M.methodArgs.push(L);M.methodArgs.reverse();var N=G.apply(H,M.methodArgs);M=null;return N;});}else{f.error((I.isViewMethod?"method":"action")+' "'+I.methodName+'" not found');}I=null;});});};var p=function(E){var F={};var D=E.split("<");F.filedName=(D[1]||"");var C=(D[0]||"").split(":");F.attrName=(C[0]||"");F.attrArg=(C[1]||"");return F;};var i=function(D){var C=D.ui.find("[data-bind]");if(D.ui.attr("[data-bind]")){C.splice(0,0,D.ui[0]);}C.each(function(){var F=a(this);var E=F.attr("data-bind");if(!E){return;}E=E.split(";");A.each(E,function(I,G){G=p(G);if(F[G.attrName]){var H=h(D.model,G.filedName);if(G.attrName&&G.attrArg){F[G.attrName](G.attrArg,H);}else{F[G.attrName](H);}}});});};var z=function(D){if(!D||!D.ui){return;}var C=D.ui.find("[data-bind]");if(D.ui.attr("[data-bind]")){C.splice(0,0,D.ui[0]);}C.each(function(){var F=a(this);var E=F.attr("data-bind");if(!E){return;}E=E.split(";");A.each(E,function(H,G){G=p(G);if(F[G.attrName]){if(G.attrName&&G.attrArg){s(D.model,G.filedName,F[G.attrName](G.attrArg));}else{s(D.model,G.filedName,F[G.attrName]());}}});});return D.model;};var j=function(F){F.children=F.children||{};var D=F.ui.find("[data-view]");var C={"view":F};if(D.length<1){if(F.onChildRender){F.onChildRender(C);}return;}var E=v.create();D.each(function(){var G=a(this);E.add(function(N){var M=G.attr("data-view");if(!M){return N();}var H=G.attr("id");if(A.isNull(H)){H=A.newGuid();G.attr("id",H);}var J=G.attr("data-model")||"";var I=h(F.model,J)||F.model;var L=G.attr("data-option")||"{}";var K=l.parse(L);if(F.children[H]){F.children[H].container=G;F.children[H].render(G,N);return;}M=module.resovleUri(M,F.templateType==x.uri?F.template:location.href);require(M,function(O){F[H]=F.children[H]=new O({model:I,controller:F.controller,option:K});F.children[H].parent=F;F.children[H].root=F.root||F;F.children[H].container=G;F.children[H].render(G,N);});});});E.end(function(){if(F.onChildRender){F.onChildRender(C);}});};var t=function(D){if(!D||!D.ui){return;}if(D.ui.attr("data-role")!="page"){return;}var C=D.ui.attr("data-title");if(C){document.title=C;}};var o=function(C){if(!C||!C.ui||!C.elMap){return;}C.el={};A.each(C.elMap,function(D){C.el[D]=C.ui.find(C.elMap[D]);});};var r=exports.rootContainer=a(document.body);var B=exports.View=b.create(function(){this.templateType="";this.template="";this.model=null;this.controller=null;this.ui=null;this.el=null;this.name="";this.container=null;this.initialize=function(C){var D=this;C=C||{};D.name=A.newGuid();D.model=C.model||D.model||{};D.controller=C.controller||D.controller||{};D.template=C.template||D.template||"";D.templateType=C.templateType||D.templateType||x.uri;D.option=C.option||D.option||{};D.elMap=D.el;if(D.model.registerView){D.model.registerView(D);}};this.setModel=function(C){var D=this;D.model=C;};this.updateModel=function(){var C=this;return z(C);};this.render=function(D,C){var E=this;if(E.onPreInit){E.onPreInit({view:E});}e(E.templateType,E.template,function(H){var G=E.ui;E.ui=a(a.trim(H(E.model,{lang:m.current(),self:E,model:E.model,option:E.option})));if(!E.ui||E.ui.length<1){return f.error(E.ui);}E.root=E.root||E;var F={"view":E};o(E);i(E);k(E);j(E);t(E);if(E.onInit){E.onInit(F);}if(G){G.remove();}E.container=D||E.container||r;E.container=A.isString(D)?a(E.container):E.container;if(E.container[0].tagName!=="LINK"){E.container.append(E.ui);}else{E.container.after(E.ui);}if(E.onRender){E.onRender(F);}if(C){C(E.ui);}});};this.remove=function(){var C=this;if(C.ui){C.ui.remove();}if(C.onRemove){C.onRemove({view:C});}if(C.model.removeView){C.model.removeView(C);}C.model=null;C.controller=null;C.ui=null;C.el=null;C.name=null;C.container=null;};this.hide=function(){var C=this;if(C.ui){C.ui.hide();}if(C.onHide){C.onHide({view:C});}};this.show=function(){var C=this;if(C.ui){C.ui.show();}if(C.onShow){C.onShow({view:C});}};});exports.create=function(C,D){if(!D){D=C;C=B;}return b.create(C,D);};});