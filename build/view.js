/*csd*/define(function(require,exports,module){"use strict";var a=require("./jquery");var u=require("./touch");var b=require("./class");var v=require("./tp");var w=require("./utils");var e=require("./ajax");var j=require("./json");var d=require("./model");var q=require("./store");var r=require("./task");var g=require("./console");var k=require("./language");var h=require("./controller");var c=require("./event");var o=exports.rootContainer=a(document.body);exports.showMask=false;v.extend(w);var t=exports.templateType={uri:"uri",element:"element",content:"content"};var s=q.dataCache;var l=function(A,z,y){if(!w.isFunction(y)){return;}if(w.isNull(z)){g.error("编译模板错误");}A=A||t.uri;if(A==t.element){y(a(z).html());}else{if(A==t.uri){e.get({url:z,callback:y,dataType:"text",noMask:!exports.showMask});}else{y(z);}}};var f=function(B,A,z){if(!w.isFunction(z)){return;}if(w.isNull(A)){g.error("编译模板错误");}var y=A.split("?")[0].split("#")[0];if(s[y]){if(z){z(s[y]);}}else{l(B,A,function(C){s[y]=v.compile(C);if(z){z(s[y]);}});}};var i=function(A,z){if(!A||!z){return null;}var y=z.split(".");w.each(y,function(B,C){A=(C&&A[C])?A[C]:null;});return A;};var p=function(A,z,B){if(A===null||z===null||B===null){return;}var y=z.split(".");w.each(y,function(C,D){if(C<y.length-1){if(D&&!A[D]){A[D]=new d.Model();}A=A[D];}else{A[D]=B;}});};var n=function(z){var B={};var y=z.split(">");B.eventName=(y[0]||"");var A=(y[1]||"").split(":");B.methodName=(A[0]||"");B.methodArgs=(A[1]||"").split(",");if(w.contains(B.methodName,"!")){B.isViewMethod=true;B.methodName=B.methodName.toString().replace("!","");}return B;};var m=function(A){var B={};var z=A.split("<");B.filedName=(z[1]||"");var y=(z[0]||"").split(":");B.attrName=(y[0]||"");B.attrArg=(y[1]||"");return B;};var x=b.create(function(){this.templateType="";this.template="";this.model=null;this.controller=null;this.ui=null;this.el=null;this.name="";this.container=null;this.initialize=function(y){var z=this;y=y||{};z.id=y.id||w.newGuid();z.model=y.model||z.model||{};z.controller=y.controller||z.controller||{};z.container=y.container||z.container||o;z.template=y.template||z.template||"";z.templateType=y.templateType||z.templateType||t.uri;z.options=y.options||z.options||{};if(z.model.registerView){z.model.registerView(z);}z.elmaps=z.el;z.el={};};this.setModel=function(y){var z=this;z.model=y;};this.removeElementEvent=function(y,A,z){if(!y||!y.each){return;}y.each(function(C,B){c(B).off(A,z);});};this.clearElementEvent=function(y){if(!y||!y.each){return;}y.each(function(A,z){c.clear(z);});};this.addElementEvent=function(y,A,z){if(!y||!y.each){return;}y.each(function(C,B){c(B).on(A,z);});};this.unbindEvent=function(){var y=this;if(!y.el){return;}w.each(y.el,function(A,z){if(!w.isString(z)&&!w.isFunction(z)){y.clearElementEvent(z);}});};this.deepClearEvent=function(){var y=this;y.unbindEvent();if(!y.children){return;}w.each(y.children,function(A,z){if(z&&z.unbindEvent){z.unbindEvent();}});};this.bindEvent=function(){var z=this;var y=z.ui.find("[data-event]");if(z.ui.attr("data-event")){y.splice(0,0,z.ui[0]);}y.each(function(){var A=a(this);var B=w.newGuid();z.el=z.el||{};z.el[B]=A;var C=A.attr("data-event");if(!C){return;}C=C.split(";");A.view=z;w.each(C,function(H,G){var F=n(G);var E=F.isViewMethod?z:z.controller;var D=E[F.methodName];if(D){z.addElementEvent(A,F.eventName,function(I){var J=n(G);I.$element=A;I.element=A[0];I.view=A.view;if(A.view.controller&&A.view.controller.route){I.routeData=A.view.controller.route.routeData;}J.methodArgs.reverse();J.methodArgs.push(I);J.methodArgs.reverse();var K=D.apply(E,J.methodArgs);J=null;return K;});}else{g.error((F.isViewMethod?"method":"action")+' "'+F.methodName+'" not found');}});});};this.bindData=function(){var z=this;var y=z.ui.find("[data-bind]");if(z.ui.attr("data-bind")){y.splice(0,0,z.ui[0]);}y.each(function(){var B=a(this);var A=B.attr("data-bind");if(!A){return;}A=A.split(";");w.each(A,function(E,C){C=m(C);if(B[C.attrName]){var D=i(z.model,C.filedName);if(C.attrName&&C.attrArg){B[C.attrName](C.attrArg,D);}else{B[C.attrName](D);}}});});};this.updateModel=function(){var z=this;if(!z||!z.ui){return;}var y=z.ui.find("[data-bind]");if(z.ui.attr("[data-bind]")){y.splice(0,0,z.ui[0]);}y.each(function(){var B=a(this);var A=B.attr("data-bind");if(!A){return;}A=A.split(";");w.each(A,function(D,C){C=m(C);if(B[C.attrName]){if(C.attrName&&C.attrArg){p(z.model,C.filedName,B[C.attrName](C.attrArg));}else{p(z.model,C.filedName,B[C.attrName]());}}});});return z.model;};this.renderChildView=function(){var B=this;B.children=B.children||{};var z=B.ui.find("[data-view]");var y={"view":B};if(z.length<1){if(B.onChildRender){B.onChildRender(y);}return;}var A=r.create();z.each(function(){var C=a(this);A.add(function(J){var I=C.attr("data-view");if(!I){return J();}var D=C.attr("id");if(w.isNull(D)){D=w.newGuid();C.attr("id",D);}var F=C.attr("data-model")||"";var E=i(B.model,F)||B.model;var H=C.attr("data-options")||"{}";var G=j.parse(H);if(B.children[D]){B.children[D].container=C;B.children[D].render(C,J);return;}I=module.resovleUri(I,B.templateType==t.uri?B.template:location.href);require(I,function(K){B[D]=B.children[D]=new K({id:D,model:E,controller:B.controller,options:G});B.children[D].parent=B;B.children[D].root=B.root||B;B.children[D].container=C;B.children[D].render(C,J);});});});A.end(function(){if(B.onChildRender){B.onChildRender(y);}});};this.removeChildView=function(){var y=this;if(!y.children){return;}w.each(y.children,function(A,z){if(z&&z.remove){z.remove();}});};this.setPageTitle=function(){var z=this;if(!z||!z.ui){return;}if(z.ui.attr("data-role")!="page"){return;}var y=z.ui.attr("data-title");if(y){document.title=y;}};this.mapElements=function(){var y=this;if(!y||!y.ui||!y.elmaps){return;}y.el=y.el||{};w.each(y.elmaps,function(A,z){y.el[A]=y.ui.find(z);});};this.render=function(z,y){var B=this;B.deepClearEvent();var A=B.ui;if(B.onPreInit){B.onPreInit({view:B});}f(B.templateType,B.template,function(D){B.ui=a(a.trim(D(B.model,{lang:k.current(),self:B,model:B.model,options:B.options})));if(!B.ui||B.ui.length<1){return g.error('"'+B.name+'" 发现异常');}B.root=B.root||B;var C={"view":B};B.mapElements(B);B.bindData(B);B.bindEvent(B);B.renderChildView(B);B.setPageTitle(B);if(B.onInit){B.onInit(C);}if(A){A.empty().remove();A=null;}B.container=z||B.container||o;if(!B.container){g.error("container error.");}if(B.container[0].tagName!=="LINK"){B.container.append(B.ui);}else{B.container.after(B.ui);}if(B.onRender){B.onRender(C);}if(y){y(B.ui);}});};this.remove=function(){var y=this;if(y.onRemove){y.onRemove({view:y});}if(y.model&&y.model.removeView){y.model.removeView(y);}y.unbindEvent();y.removeChildView();if(y.ui){y.ui.empty().remove();}w.each(y,function(z){y[z]=null;});};this.hide=function(){var y=this;if(y.ui){y.ui.hide();}if(y.onHide){y.onHide({view:y});}};this.show=function(){var y=this;if(y.ui){y.ui.show();}if(y.onShow){y.onShow({view:y});}};});exports.create=function(y,z){if(!z){z=y;y=x;}return b.create(y,z);};exports.View=x;});