<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/view.js - Mokit API</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../logo.png" title="Mokit API"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: v2.0 Beta 34</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Ajax.html">Ajax</a></li>
            
                <li><a href="../classes/App.html">App</a></li>
            
                <li><a href="../classes/Base64.html">Base64</a></li>
            
                <li><a href="../classes/Class.html">Class</a></li>
            
                <li><a href="../classes/Console.html">Console</a></li>
            
                <li><a href="../classes/Context.html">Context</a></li>
            
                <li><a href="../classes/Controller.html">Controller</a></li>
            
                <li><a href="../classes/Event.html">Event</a></li>
            
                <li><a href="../classes/Grid.html">Grid</a></li>
            
                <li><a href="../classes/Json.html">Json</a></li>
            
                <li><a href="../classes/Language.html">Language</a></li>
            
                <li><a href="../classes/Mask.html">Mask</a></li>
            
                <li><a href="../classes/Model.html">Model</a></li>
            
                <li><a href="../classes/Move.html">Move</a></li>
            
                <li><a href="../classes/Navigation.html">Navigation</a></li>
            
                <li><a href="../classes/Route.html">Route</a></li>
            
                <li><a href="../classes/Sortable.html">Sortable</a></li>
            
                <li><a href="../classes/Store.html">Store</a></li>
            
                <li><a href="../classes/Style.html">Style</a></li>
            
                <li><a href="../classes/Task.html">Task</a></li>
            
                <li><a href="../classes/Utils.html">Utils</a></li>
            
                <li><a href="../classes/View.html">View</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/mokit.html">mokit</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src/view.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
﻿
/**
 * 视图
 * @module mokit
 * @class View
 */
define(function(require, exports, module) {
    &quot;require:nomunge,exports:nomunge,module:nomunge&quot;;
    &quot;use strict&quot;;

    var $ = require(&#x27;./jquery&#x27;),
        $class = require(&quot;./class&quot;),
        tp = require(&#x27;./tp&#x27;),
        utils = require(&#x27;./utils&#x27;),
        ajax = require(&#x27;./ajax&#x27;),
        json = require(&#x27;./json&#x27;),
        $model = require(&#x27;./model&#x27;),
        store = require(&#x27;./store&#x27;),
        Task = require(&#x27;./task&#x27;),
        console = require(&#x27;./console&#x27;),
        language = require(&#x27;./language&#x27;),
        eventMgr = require(&#x27;./event&#x27;);

    //----------------------有关模板处理开始----------------------
    tp.extend(utils);
    /**
     * 模板类型
     */
    var templateType = exports.templateType = {
        uri: &#x27;uri&#x27;,
        element: &#x27;element&#x27;,
        content: &#x27;content&#x27;
    };

    /**
     * 模板编译缓存
     */
    var templateCache = store.dataCache;

    /*
     * 获取模板内容
     * @param  {String}   tplType  模板类型
     * @param  {String}   tpl      模板
     * @param  {Function} callback 加载完成回调函数
     * @return {NULL}              无返值
     */
    var loadTemplate = function(tplType, tpl, callback) {
        tplType = tplType || templateType.uri;
        if (!tpl || !callback) return;
        if (tplType == templateType.element) {
            callback($(tpl).html());
        } else if (tplType == templateType.uri) {
            ajax.get({
                url: tpl,
                callback: callback,
                dataType: &#x27;text&#x27;
            });
        } else {
            callback(tpl);
        }
    };

    /**
     * 编译模板
     */
    var complieTemplate = function(tplType, tpl, callback) {
        var cacheKey = tpl.split(&#x27;?&#x27;)[0].split(&#x27;#&#x27;)[0];
        if (templateCache[cacheKey]) {
            if (callback) callback(templateCache[cacheKey]);
        } else {
            loadTemplate(tplType, tpl, function(content) {
                templateCache[cacheKey] = tp.compile(content);
                if (callback) callback(templateCache[cacheKey]);
            });
        }
    };
    //----------------------有关模板处理结束----------------------


    //----------------------有关模型处理开始----------------------

    /*
     * 获取一个子模型对象
     * @param  {Object} root 源模型对象
     * @param  {Object} path 子模型对象路径
     * @return {NULL}        取到的子模型对象
     */
    var getModel = function(root, path) {
        if (!root || !path) return null;
        var nameList = path.split(&#x27;.&#x27;);
        utils.each(nameList, function(i, key) {
            root = (key &amp;&amp; root[key]) ? root[key] : null;
        });
        return root;
    };

    /*
     * 设置一个子模型对象
     * @param  {Object} root  源模型对象
     * @param  {Object} path  子模型对象路径
     * @param  {Object} value 子对象
     * @return {NULL}         无返回值
     */
    var setModel = function(root, path, value) {
        if (root === null || path === null || value === null) return;
        var nameList = path.split(&#x27;.&#x27;);
        utils.each(nameList, function(i, key) {
            if (i &lt; nameList.length - 1) {
                if (key &amp;&amp; !root[key]) {
                    root[key] = new $model.Model();
                }
                root = root[key];
            } else {
                root[key] = value;
            }
        });
    };
    //----------------------有关模板处理结束----------------------


    /**
     * 解析事件表达式
     */
    var parseEventExpr = function(expr) {
        var rs = {};
        var eventParts = expr.split(&#x27;&gt;&#x27;);
        rs.eventName = (eventParts[0] || &#x27;&#x27;);
        var methodParts = (eventParts[1] || &#x27;&#x27;).split(&#x27;:&#x27;);
        rs.methodName = (methodParts[0] || &#x27;&#x27;);
        rs.methodArgs = (methodParts[1] || &#x27;&#x27;).split(&#x27;,&#x27;);
        //如果方法名包括‘!’则认为是View方法，否则是Controllor的Action
        if (utils.contains(rs.methodName, &#x27;!&#x27;)) {
            rs.isViewMethod = true;
            rs.methodName = rs.methodName.toString().replace(&#x27;!&#x27;, &#x27;&#x27;);
        }
        return rs;
    };

    /**
     * 处理事件绑定
     */
    var handleEvent = function(view) {
        //查找所有事件绑定元素
        var elements = view.ui.find(&quot;[data-event]&quot;);
        if (view.ui.attr(&#x27;[data-event]&#x27;)) {
            elements.splice(0, 0, view.ui[0]); //将UI最顶层容器也加入元素组中
        }
        elements.each(function() {
            var element = $(this);
            var eventItems = element.attr(&#x27;data-event&#x27;);
            if (!eventItems) return;
            eventItems = eventItems.split(&#x27;;&#x27;);
            //遍历某一元素的事件列表
            utils.each(eventItems, function(i, exprStr) {
                var expr = parseEventExpr(exprStr);
                var eventTarget = expr.isViewMethod ? view : view.controller;
                var eventHandler = eventTarget[expr.methodName];
                if (eventHandler) {
                    element.on(expr.eventName, function(context) {
                        var expr = parseEventExpr(exprStr);
                        context.$element = element;
                        context.element = element[0];
                        context.view = view;
                        context.routeData = view.controller.route.routeData;
                        expr.methodArgs.reverse();
                        expr.methodArgs.push(context);
                        expr.methodArgs.reverse();
                        var rs = eventHandler.apply(eventTarget, expr.methodArgs);
                        expr = null;
                        return rs;
                    });
                } else {
                    console.error((expr.isViewMethod ? &#x27;method&#x27; : &#x27;action&#x27;) + &#x27; &quot;&#x27; + expr.methodName + &#x27;&quot; not found&#x27;);
                }
                expr = null;
            });
        });
    };

    /**
     * 解析绑定表达式
     */
    var parseBindExpr = function(expr) {
        var rs = {};
        var bindParts = expr.split(&#x27;&lt;&#x27;);
        rs.filedName = (bindParts[1] || &#x27;&#x27;);
        var attrParts = (bindParts[0] || &#x27;&#x27;).split(&#x27;:&#x27;);
        rs.attrName = (attrParts[0] || &#x27;&#x27;);
        rs.attrArg = (attrParts[1] || &#x27;&#x27;);
        return rs;
    };

    /**
     * 处理数据绑定
     */
    var handleBind = function(view) {
        var elements = view.ui.find(&quot;[data-bind]&quot;);
        if (view.ui.attr(&#x27;[data-bind]&#x27;)) {
            elements.splice(0, 0, view.ui[0]); //将UI最顶层容器也加入元素组中
        }
        elements.each(function() {
            var element = $(this);
            var bindItems = element.attr(&#x27;data-bind&#x27;);
            if (!bindItems) return;
            bindItems = bindItems.split(&#x27;;&#x27;);
            utils.each(bindItems, function(i, expr) {
                expr = parseBindExpr(expr);
                if (element[expr.attrName]) {
                    var filed = getModel(view.model, expr.filedName);
                    if (expr.attrName &amp;&amp; expr.attrArg) {
                        element[expr.attrName](expr.attrArg, filed);
                    } else {
                        element[expr.attrName](filed);
                    }
                }
            });
        });
    };

    var updateModel = function(view) {
        if (!view || !view.ui) return;
        var elements = view.ui.find(&quot;[data-bind]&quot;);
        if (view.ui.attr(&#x27;[data-bind]&#x27;)) { //将UI最顶层容器也加入元素组中
            elements.splice(0, 0, view.ui[0]);
        }
        elements.each(function() {
            var element = $(this);
            var bindItems = element.attr(&#x27;data-bind&#x27;);
            if (!bindItems) return;
            bindItems = bindItems.split(&#x27;;&#x27;);
            utils.each(bindItems, function(i, expr) {
                expr = parseBindExpr(expr);
                if (element[expr.attrName]) {
                    if (expr.attrName &amp;&amp; expr.attrArg) {
                        setModel(view.model, expr.filedName, element[expr.attrName](expr.attrArg));
                    } else {
                        setModel(view.model, expr.filedName, element[expr.attrName]());
                    }
                }
            });
        });
        return view.model;
    };

    /**
     * 处理子视图
     */
    var handleChildView = function(view) {
        view.children = view.children || {};
        var childs = view.ui.find(&#x27;[data-view]&#x27;);
        var _context = {
            &#x27;view&#x27;: view
        };
        if (childs.length &lt; 1) {
            if (view.onChildRender) view.onChildRender(_context);
            return;
        }
        var task = Task.create();
        childs.each(function() {
            var childHolder = $(this);
            task.add(function(done) {
                var childUri = childHolder.attr(&#x27;data-view&#x27;);
                if (!childUri) {
                    return done();
                }
                //取子视图Id及子模型
                var childId = childHolder.attr(&#x27;id&#x27;);
                if (utils.isNull(childId)) {
                    childId = utils.newGuid();
                    childHolder.attr(&#x27;id&#x27;, childId);
                }
                var childModelPath = childHolder.attr(&#x27;data-model&#x27;) || &#x27;&#x27;;
                var childModel = getModel(view.model, childModelPath) || view.model;
                //取子视图选项
                var childOptionJson = childHolder.attr(&#x27;data-option&#x27;) || &#x27;{}&#x27;;
                var childOption = json.parse(childOptionJson);
                //如果已存在
                if (view.children[childId]) {
                    //view.children[childId].model = childModel;
                    view.children[childId].container = childHolder;
                    view.children[childId].render(childHolder, done);
                    return;
                };
                //如果不存在
                childUri = module.resovleUri(childUri, view.templateType == templateType.uri ? view.template : location.href);
                require(childUri, function(ChildView) {
                    view[childId] = view.children[childId] = new ChildView({
                        model: childModel,
                        controller: view.controller,
                        option: childOption
                    });
                    view.children[childId].parent = view;
                    view.children[childId].root = view.root || view;
                    view.children[childId].container = childHolder;
                    view.children[childId].render(childHolder, done);
                });
            });
        });
        task.end(function() {
            /**
             * 在所有子视图呈现完成时
             * @event onChildRender
             */
            if (view.onChildRender) view.onChildRender(_context);
        });
    };

    var setPageTitle = function(view) {
        if (!view || !view.ui) return;
        if (view.ui.attr(&#x27;data-role&#x27;) != &#x27;page&#x27;) return;
        var title = view.ui.attr(&#x27;data-title&#x27;);
        if (title) document.title = title;
    }

    /**
     * 按照字典映射元素
     */
    var mapElements = function(view) {
        if (!view || !view.ui || !view.elMap) return;
        view.el = {};
        utils.each(view.elMap, function(key) {
            view.el[key] = view.ui.find(view.elMap[key]);
        });
    };

    var rootContainer = exports.rootContainer = $(document.body);

    //----------------------视图基类开始----------------------

    /**
     * 视图基类
     */
    var View = exports.View = $class.create(function() {

        /**
         * 视图模板型型
         * @property template
         */
        this.templateType = &#x27;&#x27;;

        /**
         * 视图所使用的模板（URL或模板内容）
         * @property template
         */
        this.template = &#x27;&#x27;;

        /**
         * 视图绑定的 ‘对象模型’
         * @property model
         */
        this.model = null;

        /**
         * 管理视图的 Controller
         * @property controller
         */
        this.controller = null;

        /**
         * 视图UI对角
         * @property ui
         */
        this.ui = null;

        /**
         * 视图的元素映射对象
         * 格式 {&#x27;name&#x27;:&#x27;CSS3 选择器&#x27;,...}
         * @property el
         */
        this.el = null;

        /**
         * 视图的名称（暂无用途）
         * @property name
         */
        this.name = &#x27;&#x27;;

        /**
         * 在视图的容器
         * @property container
         */
        this.container = null;

        /**
         * 视图构造函数
         * @method initialize
         * @param  {Object} option 构造选项
         * @return {NULL}          无返回值
         */
        this.initialize = function(option) {
            var self = this;
            option = option || {};
            self.name = utils.newGuid();
            self.model = option.model || self.model || {};
            self.controller = option.controller || self.controller || {};
            self.template = option.template || self.template || &#x27;&#x27;;
            self.templateType = option.templateType || self.templateType || templateType.uri;
            self.option = option.option || self.option || {}; //option是用json控制视图行为或外观的
            self.elMap = self.el;
            if (self.model.registerView) {
                self.model.registerView(self);
            }
        };

        /**
         * 设置视图当前模型
         * @method setModel
         * @param {Model} model 模型
         */
        this.setModel = function(model) {
            var self = this;
            self.model = model;
        };

        /**
         * 更新模型数据
         * @method updateModel
         */
        this.updateModel = function() {
            var self = this;
            return updateModel(self);
        };

        /**
         * 呈现一个视图
         * @method render
         * @param  {Object}   container 容器(省略时自动在原有位置重绘)
         * @param  {Function} callback  完成呈现回调
         * @return {NULL}               无返回值
         */
        this.render = function(container, callback) {
            var self = this;
            /**
             * 在视图初始化前
             * @event onPreInit
             */
            if (self.onPreInit) self.onPreInit({
                view: self
            });
            complieTemplate(self.templateType, self.template, function(tpl) {
                var old_ui = self.ui;
                self.ui = $($.trim(tpl(self.model, {
                    lang: language.current(),
                    self: self,
                    model: self.model, //tp 模板引擎其实也会自动将执行时的第一个参数放入 $.model;
                    option: self.option
                })));
                if (!self.ui || self.ui.length &lt; 1) {
                    return console.error(self.ui);
                }
                self.root = self.root || self;
                var _context = {
                    &#x27;view&#x27;: self
                };
                mapElements(self);
                handleBind(self);
                handleEvent(self);
                handleChildView(self);
                setPageTitle(self);
                /**
                 * 在视图初始化完成时
                 * @event onInit
                 */
                if (self.onInit) self.onInit(_context);
                if (old_ui) old_ui.remove();
                self.container = container || self.container || rootContainer;
                self.container = utils.isString(container) ? $(self.container) : self.container;
                if (self.container[0].tagName !== &#x27;LINK&#x27;) {
                    self.container.append(self.ui);
                } else {
                    self.container.after(self.ui);
                }

                /**
                 * 在视图呈现完成时
                 * @event onRender
                 */
                if (self.onRender) self.onRender(_context);
                if (callback) callback(self.ui);
            });
        };

        /**
         * 移动除一个视图
         * @method remove
         * @return {NULL} 无返回值
         */
        this.remove = function() {
            var self = this;
            if (self.ui) self.ui.remove();
            if (self.onRemove) self.onRemove({
                view: self
            });
            if (self.model.removeView) {
                self.model.removeView(self);
            }
            self.model = null;
            self.controller = null;
            self.ui = null;
            self.el = null;
            self.name = null;
            self.container = null;
        };

        /**
         * 隐藏视图
         * @method hide
         * @return {NULL} 无返回值
         */
        this.hide = function() {
            var self = this;
            if (self.ui) self.ui.hide();
            if (self.onHide) self.onHide({
                view: self
            });
        };

        /**
         * 显示视图
         * @method show
         * @return {NULL} 无返回值
         */
        this.show = function() {
            var self = this;
            if (self.ui) self.ui.show();
            if (self.onShow) self.onShow({
                view: self
            });
        };

    });
    //----------------------视图基类结束----------------------

    /**
     * 创建一个视图
     * @method create
     * @param {View} base 视图基类（可省略）
     * @static
     */
    exports.create = function(base, context) {
        if (!context) {
            context = base;
            base = View;
        }
        return $class.create(base, context);
    };

});

/**** 参数对象 Context 的说明 ****/

/**
 * View 或 Controller 的参数对象
 * View 的所有 “事件方法” 的第一个参数
 * Controller 所有 “Action 方法” 的第一个参数
 * @class Context
 * @module mokit
 */

/**
 * 当前视图
 * @property view
 */

/**
 * 根视图
 * @property rootView
 */

/**
 * URL 路由数据 (仅在 Controller 中可以访问)
 * @property routeData
 */

/**
 * 事件对象
 * @property event
 */

/**
 * 事件源 jQuery 对象
 * @property $element
 */

/**
 * 事件源原生对对象
 * @property element
 */
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
